# 实施方案：基于 Mac 硬件加速 (VideoToolbox) 的高性能视频导出

为了确保导出性能，我们将直接调用 Mac 系统的硬件编码器，而非低效的软件模拟或浏览器端处理。

## 1. 核心技术：Mac 硬件加速渲染
- **后端执行**：导出逻辑运行在 Node.js 后端，直接调用宿主机的 FFmpeg 二进制文件。
- **硬件编码**：在 FFmpeg 命令中明确指定 `-c:v h264_videotoolbox`。
    - 这将调用 Mac 的 **Apple Silicon (M1/M2/M3)** 或 **Intel T2** 芯片中的专用视频编码硬件，性能比传统的软件编码 (`libx264`) 提升数倍，且不占用过高 CPU。

## 2. 后端：实现渲染引擎 ([server/index.js](file:///Users/bytedance/Documents/trae_projects/re-act/server/index.js))
新增 `/api/export` 接口：
- **复杂滤镜链 (Filter Graph)**：
    - 为每个片段生成 `[v_in]trim=...,setpts=...[v_out]` 逻辑。
    - 处理音频变速：使用 `atempo` 滤镜，并根据倍率（如 >2.0x）进行链式调用，确保音轨不损坏。
- **高性能合成**：
    - 使用 `filter_complex` 结合 `concat` 实现一次性流式渲染，避免产生大量中间临时文件。
- **硬件参数优化**：
    - 指定 `-realtime 1` 和硬件编码器参数，确保渲染速度最大化。

## 3. 前端：导出交互升级 ([App.jsx](file:///Users/bytedance/Documents/trae_projects/re-act/src/App.jsx))
- **导出流控**：新增 `Export` 状态反馈，在渲染期间展示进度提示。
- **FormData 传输**：将轨道上的 `playbackRate`、`start`、`end` 完整发送给后端。
- **二进制流接收**：直接接收后端吐出的 `application/octet-stream` 视频流并触发自动下载。

## 4. 关键指标验证
- **渲染速度**：预期对于短视频，渲染时间将远小于视频时长（得益于 VideoToolbox）。
- **音画同步**：验证在极速（如 4x）或极慢（如 0.2x）情况下，导出的视频声音与画面是否依然严丝合缝。
- **资源占用**：通过 Mac 活动监视器验证是否成功调用了 GPU/硬件编码模块。

确认后我将开始配置这套高性能渲染链路。